<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password - AI Teaching Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
</head>
<body class="bg-gradient-to-br from-purple-600 via-pink-500 to-red-500 min-h-screen flex items-center justify-center p-4">
    <!-- Toast Notification -->
    <div id="toast" class="fixed top-4 right-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg p-4 flex items-center gap-3 animate__animated animate__fadeInRight">
            <span id="toast-icon" class="text-2xl"></span>
            <div>
                <p id="toast-title" class="font-semibold text-gray-800"></p>
                <p id="toast-message" class="text-sm text-gray-600"></p>
            </div>
        </div>
    </div>

    <div class="w-full max-w-md">
        <!-- Logo -->
        <div class="text-center mb-8 animate__animated animate__fadeInDown">
            <h1 class="text-5xl font-bold text-white mb-2">üîê</h1>
            <h2 class="text-3xl font-bold text-white">Forgot Password</h2>
            <p class="text-white/80 mt-2">We'll send you a reset code</p>
        </div>

        <!-- Reset Card -->
        <div class="bg-white rounded-2xl shadow-2xl p-8 animate__animated animate__fadeInUp">
            <!-- Step 1: Enter Email -->
            <div id="step1" class="step">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Enter Your Email</h3>
                <p class="text-sm text-gray-600 mb-6">We'll send a 6-digit code to your registered email address.</p>
                
                <form onsubmit="sendResetCode(event)">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                        <input type="email" id="email" required placeholder="student@example.com" 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>

                    <button type="submit" class="w-full py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg font-semibold hover:shadow-lg transition transform hover:scale-105">
                        Send Reset Code
                    </button>
                </form>
            </div>

            <!-- Step 2: Enter Code -->
            <div id="step2" class="step hidden">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Enter Reset Code</h3>
                <p class="text-sm text-gray-600 mb-6">We sent a 6-digit code to <strong id="email-display"></strong></p>
                
                <form onsubmit="verifyCode(event)">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Reset Code</label>
                        <input type="text" id="reset-code" required placeholder="123456" maxlength="6" pattern="[0-9]{6}"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-center text-2xl font-bold tracking-widest">
                        <p class="text-xs text-gray-500 mt-2">Code expires in 15 minutes</p>
                    </div>

                    <button type="submit" class="w-full py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg font-semibold hover:shadow-lg transition transform hover:scale-105">
                        Verify Code
                    </button>
                    
                    <button type="button" onclick="resendCode()" class="w-full mt-3 py-2 text-purple-600 hover:text-purple-700 text-sm font-medium">
                        Didn't receive code? Resend
                    </button>
                </form>
            </div>

            <!-- Step 3: New Password -->
            <div id="step3" class="step hidden">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Set New Password</h3>
                <p class="text-sm text-gray-600 mb-6">Choose a strong password for your account.</p>
                
                <form onsubmit="resetPassword(event)">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">New Password</label>
                        <input type="password" id="new-password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="6"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <p class="text-xs text-gray-500 mt-1">At least 6 characters</p>
                    </div>

                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Confirm Password</label>
                        <input type="password" id="confirm-password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="6"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>

                    <button type="submit" class="w-full py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg font-semibold hover:shadow-lg transition transform hover:scale-105">
                        Reset Password
                    </button>
                </form>
            </div>

            <!-- Back to Login -->
            <div class="mt-6 text-center">
                <a href="login.html" class="text-sm text-purple-600 hover:text-purple-700 font-medium">
                    ‚Üê Back to Login
                </a>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://ai-teaching-assistant-backend-5u22.onrender.com/api';
        let userEmail = '';
        let resetCode = '';

        function showToast(icon, title, message) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-icon').textContent = icon;
            document.getElementById('toast-title').textContent = title;
            document.getElementById('toast-message').textContent = message;
            
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 4000);
        }

        function showStep(stepNumber) {
            document.querySelectorAll('.step').forEach(step => step.classList.add('hidden'));
            document.getElementById(`step${stepNumber}`).classList.remove('hidden');
        }

        async function sendResetCode(event) {
            event.preventDefault();
            
            userEmail = document.getElementById('email').value;

            try {
                const response = await fetch(`${API_BASE_URL}/auth/forgot-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: userEmail })
                });

                const data = await response.json();

                if (response.ok) {
                    showToast('‚úÖ', 'Code Sent', 'Check your email for the reset code');
                    document.getElementById('email-display').textContent = userEmail;
                    showStep(2);
                    
                    // For development - show code in console
                    if (data.resetCode) {
                        console.log('Reset Code (DEV):', data.resetCode);
                        showToast('üîë', 'Dev Mode', `Code: ${data.resetCode}`);
                    }
                } else {
                    showToast('‚ùå', 'Error', data.error || 'Failed to send code');
                }
            } catch (error) {
                showToast('‚ùå', 'Error', 'Connection failed. Please try again.');
            }
        }

        async function verifyCode(event) {
            event.preventDefault();
            
            resetCode = document.getElementById('reset-code').value;

            try {
                const response = await fetch(`${API_BASE_URL}/auth/verify-reset-code`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: userEmail, code: resetCode })
                });

                const data = await response.json();

                if (response.ok) {
                    showToast('‚úÖ', 'Verified', 'Code verified successfully');
                    showStep(3);
                } else {
                    showToast('‚ùå', 'Error', data.error || 'Invalid code');
                }
            } catch (error) {
                showToast('‚ùå', 'Error', 'Connection failed. Please try again.');
            }
        }

        async function resetPassword(event) {
            event.preventDefault();
            
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            if (newPassword !== confirmPassword) {
                showToast('‚ùå', 'Error', 'Passwords do not match');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/auth/reset-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        email: userEmail, 
                        code: resetCode, 
                        newPassword 
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showToast('‚úÖ', 'Success', 'Password reset successfully!');
                    
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                } else {
                    showToast('‚ùå', 'Error', data.error || 'Failed to reset password');
                }
            } catch (error) {
                showToast('‚ùå', 'Error', 'Connection failed. Please try again.');
            }
        }

        async function resendCode() {
            showToast('‚è≥', 'Sending', 'Resending code...');
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/forgot-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: userEmail })
                });

                const data = await response.json();

                if (response.ok) {
                    showToast('‚úÖ', 'Sent', 'New code sent to your email');
                    
                    if (data.resetCode) {
                        console.log('Reset Code (DEV):', data.resetCode);
                    }
                } else {
                    showToast('‚ùå', 'Error', 'Failed to resend code');
                }
            } catch (error) {
                showToast('‚ùå', 'Error', 'Connection failed');
            }
        }
    </script>
</body>
</html>
